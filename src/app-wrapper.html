<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">

<dom-module id="app-wrapper">
  <template>
    <style>
      :host {
        display: block;
      }
      prymtym-app[unresolved] {
        display: block;
        height: 56px;
        width: 100vw;
        background: #BF360C;
      }

      prymtym-sign[unresolved] {
        display: block;
        height: 100vh;
        //background: #000;
        background-image: url('../images/app-icon.svg');
        background-repeat: no-repeat;
        background-size: 200px;
        background-position: center;
      }
    </style>
    <app-location route="{{route}}"></app-location>

    <app-localstorage-document id="tokenDoc" key="firebase:authUser:AIzaSyBi00fVYW26MvFFCqUFOzWYQpaBwi5rE40:prymtym" data="{{token}}"  zeroValue="-1"></app-localstorage-document>
    <firebase-auth
      app-name="prymtym"
      id="auth"
      user="{{user}}"
      provider="google"
      on-error="handleError"
      signed-in="{{signedIn}}"
      >
    </firebase-auth>
    <section id="pages">
      <prymtym-app id="ptapp"  route="{{route}}"></<prymtym-app>
    </section>

  </template>
  <script>
    Polymer({
      is: 'app-wrapper',
      properties: {
        token: {
          observer: '_tokenChanged'
        }
      },
      listeners: {
        'change-section': '_onChangeSection',
        'firebase-signin': '_signIn'
      },
      created: function () {
        this.removeAttribute('unresolved');
      },
      ready: function () {
        Polymer.RenderStatus.afterNextRender(this.$.tokenDoc, function() {
          this._initializeToken();
        }.bind(this));
      },
      _initializeToken: function () {
        //console.log("Init " + this.token);
        let page = document.createElement('div');
        // if token is undefined import sign in page
        if (this.token === undefined) {
          this.importHref(this.resolveUrl('prymtym-sign.html'),
            null, null, true);
            //console.log('Sign in page loaded');
            page.innerHTML = `<prymtym-sign unresolved id="signinPage"></prymtym-sign>`;

            // destroy undefined key
            this.$.tokenDoc.destroy();
        } else {
          // load app
          this.$.ptapp.setAttribute('unresolved', true);
          this.importHref(this.resolveUrl('prymtym-app.html'),
            null, null, true);
            //console.log('App is loaded');
            //page.innerHTML = `<prymtym-app unresolved route="` + this.route + `"></prymtym-app>`;

        }

        this.$.pages.appendChild(page);
      },
      _tokenChanged: function () {
        //console.log("Subsequent " + this.token);
      },
      _signIn: function () {
        this.$.auth.signInWithPopup()
          .then(function(response) {
            //console.log(response.credential.accessToken);
            //this.facebookAccessToken = response.credential.accessToken;
            //console.log("Signed in: " + this);

            // load app
            //this.querySelector('prymtym-sign').style.display = "none";
            this.importHref(this.resolveUrl('prymtym-app.html'),
              null, null, true);
              console.log('App is loaded');

              //hide sign in page
              const rNode = this.$.pages.children[1];
              this.$.pages.removeChild(rNode);

              /*

              let page = document.createElement('div');
              page.innerHTML = `<prymtym-app unresolved></prymtym-app>`;

              // remove sign in page



              this.$.pages.appendChild(page);
              this.querySelector('prymtym-app').setAttribute('route') = this.route;
              */

          }.bind(this))
          .catch(function(error) {

          });
      },
    });
  </script>
</dom-module>
